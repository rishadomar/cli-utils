#!/bin/bash

# Script to get git changes from multiple repositories
# Usage: ./git-my-changes [--since "date"]
# If --since is not specified, defaults to "yesterday"

# Parse command line arguments
SINCE="yesterday"
while [[ $# -gt 0 ]]; do
    case $1 in
        --since)
            SINCE="$2"
            shift 2
            ;;
        *)
            echo "Unknown option: $1"
            echo "Usage: ./git-my-changes [--since \"date\"]"
            exit 1
            ;;
    esac
done

# Hardcoded list of repository folders (relative or absolute paths)
repositories=(
    "~/projects/livingston/digital-design-system-react"
    "~/projects/livingston/digital-design-system-react-npm"
    "~/projects/livingston/digital-design-system-starter-spa"
    "~/projects/livingston/lii-pay-portal-spa"
    "~/projects/livingston/lii-pay-support-spa"
    "~/projects/livingston/tchc-spa"
    "~/projects/livingston/tchc-pdf-wrk"
    "~/projects/livingston/continuous_bonds"
)

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
GIT_CHANGES_SCRIPT="$SCRIPT_DIR/git-changes"

# Check if git-changes script exists
if [ ! -f "$GIT_CHANGES_SCRIPT" ]; then
    echo "Error: git-changes script not found at $GIT_CHANGES_SCRIPT"
    exit 1
fi

# Pass all arguments to each repository
ARGS=(--author "${USERNAME}" --since "$SINCE" --brief)

echo "=================================="
echo "Git Changes Across All Repositories"
echo "=================================="
echo ""

# Loop through each repository
for repo in "${repositories[@]}"; do
    # Expand ~ to home directory if present
    repo="${repo/#\~/$HOME}"
    
    if [ ! -d "$repo" ]; then
        echo "‚ö†Ô∏è  Warning: Repository not found: $repo"
        echo ""
        continue
    fi
    
    if [ ! -d "$repo/.git" ]; then
        echo "‚ö†Ô∏è  Warning: Not a git repository: $repo"
        echo ""
        continue
    fi
    
    echo "üìÅ Repository: $repo"
    echo "----------------------------------"
    
    # Change to repository directory and run git-changes
    (
        cd "$repo" || exit
        bash "$GIT_CHANGES_SCRIPT" "${ARGS[@]}"
    )
    
    echo ""
    echo ""
done

echo "=================================="
echo "End of Report"
echo "=================================="